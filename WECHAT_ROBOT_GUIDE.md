# ğŸ¤– ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººé…ç½®æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•é…ç½®ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººï¼Œå®ç°ç›‘å¬æ™®é€šå¾®ä¿¡ç¾¤æ¶ˆæ¯çš„åŠŸèƒ½ã€‚

## ğŸ“‹ å‰ææ¡ä»¶

- âœ… å·²æ³¨å†Œä¼ä¸šå¾®ä¿¡è´¦å·ï¼ˆå…è´¹ï¼‰
- âœ… å·²åˆ›å»ºä¼ä¸šå¾®ä¿¡åº”ç”¨
- âœ… å·²éƒ¨ç½²åç«¯æœåŠ¡åˆ° Vercel
- âœ… æ‹¥æœ‰ Vercel åŸŸå

---

## ğŸ¯ æ–¹æ¡ˆé€‰æ‹©

ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººæœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼š

| æ–¹æ¡ˆ | å¤æ‚åº¦ | ç¨³å®šæ€§ | æ¨èåº¦ |
|------|--------|--------|--------|
| **æ–¹æ¡ˆAï¼šä¼ä¸šå¾®ä¿¡åº”ç”¨ï¼ˆå›è°ƒï¼‰** | â­â­â­ | âœ… é«˜ | â­â­â­â­â­ |
| **æ–¹æ¡ˆBï¼šç¾¤æœºå™¨äººï¼ˆè½¬å‘ï¼‰** | â­ | âš ï¸ ä¸­ | â­â­â­ |

**æ¨èä½¿ç”¨æ–¹æ¡ˆA**ï¼Œè™½ç„¶é…ç½®å¤æ‚ä¸€äº›ï¼Œä½†ç¨³å®šæ€§æ›´é«˜ã€‚

---

## æ–¹æ¡ˆAï¼šä¼ä¸šå¾®ä¿¡åº”ç”¨ï¼ˆå›è°ƒï¼‰â­â­â­â­â­

### æ­¥éª¤1ï¼šåˆ›å»ºä¼ä¸šå¾®ä¿¡åº”ç”¨

1. ç™»å½•ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°ï¼šhttps://work.weixin.qq.com
2. è¿›å…¥"åº”ç”¨ç®¡ç†" â†’ "åº”ç”¨" â†’ "è‡ªå»º"
3. ç‚¹å‡»"åˆ›å»ºåº”ç”¨"
4. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - åº”ç”¨åç§°ï¼š`ç¾¤æ¶ˆæ¯ç›‘å¬`
   - åº”ç”¨ä»‹ç»ï¼š`ç›‘å¬ç¾¤æ¶ˆæ¯ï¼Œæ£€æµ‹å…³é”®å­—å¹¶å‘é€é€šçŸ¥`
   - åº”ç”¨Logoï¼šä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
5. ç‚¹å‡»"åˆ›å»º"

### æ­¥éª¤2ï¼šé…ç½®åº”ç”¨ä¿¡æ¯

åœ¨åº”ç”¨è¯¦æƒ…é¡µï¼š

#### 2.1 è·å–åº”ç”¨ä¿¡æ¯

è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
- **AgentId**ï¼šåº”ç”¨ID
- **Secret**ï¼šåº”ç”¨å¯†é’¥ï¼ˆç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®ï¼‰

#### 2.2 é…ç½®æ¥æ”¶æ¶ˆæ¯

1. æ‰¾åˆ°"æ¥æ”¶æ¶ˆæ¯"è®¾ç½®
2. ç‚¹å‡»"è®¾ç½®"
3. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

**æœåŠ¡å™¨åœ°å€ï¼ˆURLï¼‰**ï¼š
```
https://ä½ çš„vercelåŸŸå/api/webhook
```

**Token**ï¼š
- éšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š`wechat_monitor_token_2024`
- è®°å½•è¿™ä¸ªTokenï¼Œåé¢éœ€è¦ç”¨åˆ°

**EncodingAESKey**ï¼š
- ç‚¹å‡»"éšæœºç”Ÿæˆ"æŒ‰é’®
- è®°å½•è¿™ä¸ªKeyï¼Œåé¢éœ€è¦ç”¨åˆ°

4. é€‰æ‹©åŠ å¯†æ–¹å¼ï¼š`å®‰å…¨æ¨¡å¼`
5. ç‚¹å‡»"ä¿å­˜"

### æ­¥éª¤3ï¼šå¯ç”¨æ¥æ”¶æ¶ˆæ¯

1. åœ¨åº”ç”¨è¯¦æƒ…é¡µï¼Œæ‰¾åˆ°"æ¥æ”¶æ¶ˆæ¯"è®¾ç½®
2. ç¡®ä¿"æ¥æ”¶æ¶ˆæ¯"å¼€å…³å·²æ‰“å¼€
3. ç¡®ä¿"å¯ä¿¡åŸŸå"å·²æ·»åŠ ä½ çš„ Vercel åŸŸå

### æ­¥éª¤4ï¼šå°†åº”ç”¨æ·»åŠ åˆ°å¾®ä¿¡ç¾¤

#### 4.1 è·å–åº”ç”¨äºŒç»´ç 

1. åœ¨åº”ç”¨è¯¦æƒ…é¡µï¼Œæ‰¾åˆ°"åº”ç”¨äºŒç»´ç "
2. ä¸‹è½½æˆ–æˆªå›¾äºŒç»´ç 

#### 4.2 åœ¨ç¾¤ä¸­æ·»åŠ åº”ç”¨

1. æ‰“å¼€ä½ è¦ç›‘å¬çš„å¾®ä¿¡ç¾¤
2. å°†åº”ç”¨äºŒç»´ç åˆ†äº«åˆ°ç¾¤é‡Œ
3. ç¾¤æˆå‘˜æ‰«ç æ·»åŠ åº”ç”¨ä¸ºå¥½å‹

æˆ–è€…ï¼š
1. åœ¨ç¾¤ä¸­ @åº”ç”¨åç§°
2. åº”ç”¨ä¼šè‡ªåŠ¨åŠ å…¥ç¾¤èŠ

### æ­¥éª¤5ï¼šéªŒè¯é…ç½®

#### 5.1 éªŒè¯ Webhook è¿æ¥

åœ¨æµè§ˆå™¨è®¿é—®ï¼š
```
https://ä½ çš„vercelåŸŸå/api/webhook
```

åº”è¯¥è¿”å›ï¼š
```json
{
  "status": "running",
  "keywords": ["äººæ‰¾è½¦"],
  "message": "å¾®ä¿¡ç¾¤ç›‘å¬ Webhook æœåŠ¡è¿è¡Œä¸­"
}
```

#### 5.2 éªŒè¯å›è°ƒé…ç½®

1. åœ¨ä¼ä¸šå¾®ä¿¡ç®¡ç†åå°ï¼Œæ‰¾åˆ°"æ¥æ”¶æ¶ˆæ¯"è®¾ç½®
2. ç‚¹å‡»"éªŒè¯URL"
3. å¦‚æœéªŒè¯æˆåŠŸï¼Œä¼šæ˜¾ç¤º"éªŒè¯æˆåŠŸ"

#### 5.3 æµ‹è¯•æ¶ˆæ¯æ¥æ”¶

åœ¨ç›®æ ‡å¾®ä¿¡ç¾¤ä¸­å‘é€æµ‹è¯•æ¶ˆæ¯ï¼š
```
äººæ‰¾è½¦ï¼šæµ‹è¯•æ¶ˆæ¯
```

ç„¶åè®¿é—®ï¼š
```
https://ä½ çš„vercelåŸŸå/api/notifications
```

åº”è¯¥èƒ½çœ‹åˆ°æ–°å¢çš„é€šçŸ¥è®°å½•ã€‚

---

## æ–¹æ¡ˆBï¼šç¾¤æœºå™¨äººï¼ˆè½¬å‘ï¼‰â­â­â­

### æ­¥éª¤1ï¼šåœ¨ç¾¤ä¸­æ·»åŠ æœºå™¨äºº

1. æ‰“å¼€ä½ è¦ç›‘å¬çš„å¾®ä¿¡ç¾¤
2. ç‚¹å‡»ç¾¤èŠå³ä¸Šè§’çš„ "..."
3. æ‰¾åˆ°"ç¾¤æœºå™¨äºº"æˆ–"ç¾¤å·¥å…·"
4. ç‚¹å‡»"æ·»åŠ æœºå™¨äºº"
5. é€‰æ‹©"è‡ªå®šä¹‰æœºå™¨äºº"
6. å‘½åæœºå™¨äººï¼š`æ¶ˆæ¯ç›‘å¬æœºå™¨äºº`
7. ä¸Šä¼ æœºå™¨äººå¤´åƒï¼ˆå¯é€‰ï¼‰
8. ç‚¹å‡»"æ·»åŠ "

### æ­¥éª¤2ï¼šè·å– Webhook URL

æ·»åŠ æˆåŠŸåï¼Œä¼šæ˜¾ç¤ºä¸€ä¸ª Webhook URLï¼š
```
https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx
```

**å¤åˆ¶è¿™ä¸ªURLï¼**

### æ­¥éª¤3ï¼šé…ç½®æ¶ˆæ¯è½¬å‘ï¼ˆå…³é”®æ­¥éª¤ï¼‰

ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äºº**ä¸èƒ½ç›´æ¥**å‘å¤–éƒ¨ Webhook å‘é€æ¶ˆæ¯ã€‚

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹è½¬å‘æœåŠ¡**

#### é€‰é¡¹1ï¼šä½¿ç”¨ä¼ä¸šå¾®ä¿¡åº”ç”¨æ¨é€ï¼ˆæ¨èï¼‰

å›åˆ°æ–¹æ¡ˆAçš„æ­¥éª¤ï¼Œåˆ›å»ºä¼ä¸šå¾®ä¿¡åº”ç”¨å¹¶é…ç½®å›è°ƒã€‚

#### é€‰é¡¹2ï¼šä½¿ç”¨ IFTTT / Zapier è‡ªåŠ¨åŒ–

1. æ³¨å†Œ IFTTT è´¦å·ï¼ˆå…è´¹ï¼‰
2. åˆ›å»º Appletï¼š
   - If: Webhook receives a web request
   - Then: Webhook makes a web request
3. é…ç½®è§¦å‘å™¨ï¼šä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„ Webhook
4. é…ç½®åŠ¨ä½œï¼šè½¬å‘åˆ°ä½ çš„ Vercel API

#### é€‰é¡¹3ï¼šè‡ªå»ºè½¬å‘æœåŠ¡

å¦‚æœä½ æœ‰æœåŠ¡å™¨ï¼Œå¯ä»¥è‡ªå»ºè½¬å‘æœåŠ¡ï¼š

```javascript
// è½¬å‘æœåŠ¡ä»£ç 
const express = require('express');
const axios = require('axios');

const app = express();
app.use(express.json());

// ä¼ä¸šå¾®ä¿¡æœºå™¨äºº Webhook
app.post('/wechat-webhook', async (req, res) => {
  // è½¬å‘åˆ° Vercel
  await axios.post('https://ä½ çš„vercelåŸŸå/api/webhook', req.body);
  res.json({ success: true });
});

app.listen(3000);
```

---

## ğŸ”§ é…ç½®åç«¯éªŒè¯å›è°ƒ

### ä¿®æ”¹åç«¯ä»£ç ï¼ˆå¦‚æœä½¿ç”¨æ–¹æ¡ˆAï¼‰

ä¼ä¸šå¾®ä¿¡åº”ç”¨çš„å›è°ƒéœ€è¦éªŒè¯ç­¾åå’Œè§£æåŠ å¯†æ¶ˆæ¯ã€‚

#### 1. å®‰è£…ä¾èµ–

```bash
pnpm add crypto
```

#### 2. åˆ›å»ºéªŒè¯å·¥å…·

åˆ›å»º `src/utils/wechatVerify.ts`ï¼š

```typescript
import crypto from 'crypto';

export function verifyWechatSignature(
  signature: string,
  timestamp: string,
  nonce: string,
  token: string
): boolean {
  const arr = [token, timestamp, nonce].sort();
  const str = arr.join('');
  const sha1 = crypto.createHash('sha1').update(str).digest('hex');
  return sha1 === signature;
}

export function decryptMessage(
  encryptedMsg: string,
  encodingAESKey: string
): any {
  // å®ç°æ¶ˆæ¯è§£å¯†é€»è¾‘
  // å‚è€ƒï¼šhttps://developer.work.weixin.qq.com/document/path/90930
  // éœ€è¦ä½¿ç”¨ä¼ä¸šå¾®ä¿¡æä¾›çš„åŠ å¯†åº“
}
```

#### 3. æ›´æ–° Webhook è·¯ç”±

ä¿®æ”¹ `src/app/api/webhook/route.ts`ï¼š

```typescript
import { verifyWechatSignature } from '@/utils/wechatVerify';

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const msg_signature = searchParams.get('msg_signature');
  const timestamp = searchParams.get('timestamp');
  const nonce = searchParams.get('nonce');
  const echostr = searchParams.get('echostr');

  // éªŒè¯ä¼ä¸šå¾®ä¿¡å›è°ƒ
  if (msg_signature && timestamp && nonce && echostr) {
    const isValid = verifyWechatSignature(
      msg_signature,
      timestamp,
      nonce,
      process.env.WECHAT_TOKEN || 'your_token'
    );

    if (isValid) {
      return new Response(echostr);
    }
  }

  // åŸæœ‰çš„å¥åº·æ£€æŸ¥é€»è¾‘
  return NextResponse.json({
    status: 'running',
    keywords: KEYWORDS,
  });
}
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä¼ä¸šå¾®ä¿¡åº”ç”¨å›è°ƒéªŒè¯å¤±è´¥ï¼Ÿ
**A**:
- æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ EncodingAESKey æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦å¯è®¿é—®
- ç¡®ä¿ HTTPS è¯ä¹¦æœ‰æ•ˆ

### Q2: ç¾¤æœºå™¨äººæ— æ³•å‘å¤–éƒ¨ Webhook å‘é€æ¶ˆæ¯ï¼Ÿ
**A**: è¿™æ˜¯ä¼ä¸šå¾®ä¿¡çš„é™åˆ¶ï¼Œå¿…é¡»ä½¿ç”¨åº”ç”¨å›è°ƒæˆ–ç¬¬ä¸‰æ–¹è½¬å‘æœåŠ¡ã€‚

### Q3: æ¶ˆæ¯æ¥æ”¶å»¶è¿Ÿï¼Ÿ
**A**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ Vercel æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- ä¼ä¸šå¾®ä¿¡å¯èƒ½æœ‰æ¶ˆæ¯é˜Ÿåˆ—å»¶è¿Ÿ

### Q4: å¦‚ä½•ç›‘å¬å¤šä¸ªç¾¤ï¼Ÿ
**A**:
- æ–¹æ¡ˆAï¼šå°†åº”ç”¨æ·»åŠ åˆ°å¤šä¸ªç¾¤
- æ–¹æ¡ˆBï¼šåœ¨æ¯ä¸ªç¾¤ä¸­æ·»åŠ æœºå™¨äººï¼Œé…ç½®ç›¸åŒçš„è½¬å‘

### Q5: æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®ï¼Ÿ
**A**: æ£€æŸ¥ä¼ä¸šå¾®ä¿¡çš„æ¶ˆæ¯æ ¼å¼ï¼Œå¯èƒ½éœ€è¦è§£å¯†å’Œè§£æã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å®˜æ–¹æ–‡æ¡£

- ä¼ä¸šå¾®ä¿¡åº”ç”¨å¼€å‘ï¼šhttps://developer.work.weixin.qq.com/document/
- æ¶ˆæ¯æ¨é€APIï¼šhttps://developer.work.weixin.qq.com/document/path/90930
- ç¾¤æœºå™¨äººï¼šhttps://developer.work.weixin.qq.com/document/path/91770

### é—®é¢˜åé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. é”™è¯¯æˆªå›¾
2. é…ç½®ä¿¡æ¯ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
3. æ—¥å¿—è¾“å‡º

---

## ğŸ‰ å®Œæˆï¼

æ­å–œä½ ï¼ç°åœ¨ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äººå·²ç»é…ç½®å®Œæˆã€‚

- âœ… å¯ä»¥æ¥æ”¶å¾®ä¿¡ç¾¤æ¶ˆæ¯
- âœ… æ£€æµ‹"äººæ‰¾è½¦"å…³é”®å­—
- âœ… å‘é€åˆ° Vercel åç«¯
- âœ… è‡ªåŠ¨å‘é€çŸ­ä¿¡é€šçŸ¥

äº«å—ä½ çš„è‡ªåŠ¨åŒ–ç›‘å¬ç³»ç»Ÿå§ï¼ğŸš€
