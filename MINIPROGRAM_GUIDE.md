# 📱 微信小程序部署指南

本指南说明如何部署微信群监听系统的微信小程序版本。

## 📋 前提条件

### 必备条件
- ✅ 已注册微信小程序账号（免费）
- ✅ 已购买域名并备案（如果需要）
- ✅ 后端服务已部署到 Vercel（或其他云服务）
- ✅ 后端服务已配置 HTTPS

### 推荐条件
- 📋 已阅读《Vercel 部署指南》
- 📋 已阅读《企业微信群机器人配置指南》

---

## 🚀 部署步骤

### 第一步：注册微信小程序账号

1. 访问 https://mp.weixin.qq.com
2. 点击"立即注册"
3. 选择"小程序"
4. 填写账号信息：
   - 邮箱
   - 密码
   - 确认密码
5. 登录邮箱进行验证
6. 完成注册

### 第二步：完善小程序信息

登录小程序管理后台：
1. 进入"设置" → "基本设置"
2. 填写小程序信息：
   - 小程序名称：`微信群监听` 或自定义
   - 小程序简介：`实时监控微信群消息，检测关键字并发送通知`
   - 小程序头像：上传图片（120x120px）
3. 选择服务类目：
   - 工具类（推荐）
   - 或其他适合的类目
4. 保存

### 第三步：获取 AppID

1. 在小程序管理后台
2. 进入"设置" → "基本设置"
3. 复制 **AppID**（以 `wx` 开头）
4. 记录这个 AppID，后面需要用到

### 第四步：下载微信开发者工具

1. 访问 https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
2. 选择对应的操作系统（Windows/Mac/Linux）
3. 下载并安装

### 第五步：导入小程序代码

1. 打开微信开发者工具
2. 点击"+" 号，选择"导入项目"
3. 选择项目目录：
   - 选择本项目的 `miniprogram` 目录
   - 输入 AppID（第三步获取的）
   - 项目名称：`微信群监听`
4. 点击"导入"

### 第六步：配置后端 API 地址

1. 打开 `miniprogram/app.js`
2. 找到 `globalData` 中的 `baseUrl`
3. 修改为你的 Vercel 域名：

```javascript
globalData: {
  // 修改为你的 Vercel 域名
  baseUrl: 'https://你的域名.vercel.app',
  
  phoneNumbers: [],
  notifications: [],
  stats: {
    total: 0,
    notified: 0,
    unNotified: 0
  }
}
```

### 第七步：配置服务器域名白名单

#### 7.1 进入域名配置

1. 在小程序管理后台
2. 进入"开发" → "开发管理" → "开发设置"
3. 找到"服务器域名"

#### 7.2 添加 request 域名

在"request 合法域名"中，添加：
```
https://你的域名.vercel.app
```

**注意**：
- 必须是 HTTPS 域名
- 不能包含端口号
- 不能是 IP 地址
- 域名必须已备案（大陆服务器）

#### 7.3 保存配置

点击"保存"和"提交"按钮。

### 第八步：本地测试

1. 在微信开发者工具中，点击"编译"
2. 在模拟器中查看小程序效果
3. 测试各个功能：
   - 查看通知列表
   - 配置手机号
   - 查看关于页面

### 第九步：上传代码

1. 在微信开发者工具中，点击"上传"
2. 填写版本号和备注：
   - 版本号：`1.0.0`
   - 备注：`首次发布`
3. 点击"上传"

### 第十步：提交审核

1. 登录小程序管理后台
2. 进入"版本管理"
3. 找到刚上传的版本
4. 点击"提交审核"
5. 填写审核信息：
   - 测试账号：如有，提供测试账号
   - 功能页面说明：
     - 通知列表：查看微信群消息通知
     - 配置页面：配置短信通知手机号
     - 关于页面：应用说明和技术信息
6. 点击"提交"

### 第十一步：等待审核

- 审核时间：通常 1-7 个工作日
- 审核结果会通过微信通知
- 审核通过后，小程序会自动上线

---

## ⚠️ 重要提示

### 关于域名和备案

| 服务器类型 | 是否需要备案 | 推荐域名后缀 |
|-----------|-------------|-------------|
| 大陆服务器（阿里云/腾讯云） | ✅ 必须 | .com / .cn / .net |
| 域名 | ✅ 必须 | 任意 |
| 境外服务器（Vercel） | ❌ 不需要 | .app / .io / .dev |

### 域名白名单配置

**必须配置的域名类型**：
- ✅ request 域名：用于调用后端 API
- ❌ uploadFile 域名：暂不需要
- ❌ downloadFile 域名：暂不需要
- ❌ socket 域名：暂不需要

### 常见错误

#### 错误1：不在以下 request 合法域名列表中
**解决**：
1. 检查 `app.js` 中的 `baseUrl` 是否正确
2. 检查小程序后台的"request 合法域名"配置
3. 确保使用 HTTPS 协议

#### 错误2：request:fail
**解决**：
1. 检查网络连接
2. 检查后端服务是否正常运行
3. 查看开发者工具的"Console"标签页

#### 错误3：fail -2 net::ERR_NAME_NOT_RESOLVED
**解决**：
1. 检查域名是否正确
2. 检查 DNS 解析是否正常
3. 尝试使用 IP 地址（仅限本地测试）

---

## 🎯 功能测试清单

### 通知列表页面
- [ ] 页面正常加载
- [ ] 显示统计数据
- [ ] 显示通知列表
- [ ] 刷新按钮正常工作

### 配置页面
- [ ] 显示已配置的手机号
- [ ] 可以添加手机号
- [ ] 可以删除手机号
- [ ] 手机号格式验证正常

### 关于页面
- [ ] 显示应用信息
- [ ] 显示功能说明
- [ ] 显示使用说明
- [ ] 底部导航正常工作

---

## 📞 后续维护

### 更新小程序

1. 修改代码
2. 在微信开发者工具中点击"上传"
3. 在小程序后台提交新版本审核
4. 审核通过后自动上线

### 更新后端 API

- 修改 Vercel 上的代码
- Vercel 会自动重新部署
- 小程序无需更新，会自动使用新 API

---

## 🆘 常见问题

### Q1: 小程序审核被拒？
**A**:
- 检查是否符合小程序规范
- 检查是否有违规内容
- 确保功能说明清晰

### Q2: 无法访问后端 API？
**A**:
- 检查域名白名单配置
- 检查后端服务是否正常运行
- 检查网络连接

### Q3: 如何测试新功能？
**A**:
- 使用微信开发者工具的"预览"功能
- 扫码后在真机上测试
- 或使用"体验版"功能

### Q4: 可以使用本地后端测试吗？
**A**:
- 可以，但不稳定
- 需要勾选"不校验合法域名"
- 仅用于开发测试

---

## 🎉 完成！

恭喜你！现在微信群监听小程序已经部署完成。

- ✅ 小程序已上传并审核
- ✅ 可以接收后端 API 数据
- ✅ 可以配置手机号
- ✅ 可以查看通知列表
- ✅ 底部导航正常工作

用户可以在微信中搜索你的小程序，开始使用！🚀

---

## 📚 相关文档

- [Vercel 部署指南](./DEPLOYMENT.md)
- [企业微信群机器人配置指南](./WECHAT_ROBOT_GUIDE.md)
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
